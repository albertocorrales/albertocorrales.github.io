<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://albertocorrales.com/posts/Managing-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas/" /><meta property="og:url" content="https://albertocorrales.com/posts/Managing-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas/" /><meta property="og:site_name" content="Alberto Corrales Garcia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-13T23:30:14+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas" /><meta name="twitter:site" content="@albertocorralex" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-12-13T23:30:14+01:00","datePublished":"2020-12-13T23:30:14+01:00","description":"Introduction","headline":"Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas","mainEntityOfPage":{"@type":"WebPage","@id":"https://albertocorrales.com/posts/Managing-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas/"},"url":"https://albertocorrales.com/posts/Managing-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas/"}</script><title>Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas | Alberto Corrales Garcia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Alberto Corrales Garcia"><meta name="application-name" content="Alberto Corrales Garcia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://albertocorrales.com/assets/img/profile_pic.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Alberto Corrales Garcia</a></div><div class="site-subtitle font-italic">Software Development, Architecture, Cloud and Technology</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/albertocorrales" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/albertocorralex" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['albertocorralesgarcia','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Managing snapshots for Amazon ElasticSearch with Dotnet Core Lambdas</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1607898614" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 13, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/albertocorralex">Alberto Corrales Garcia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1001 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p>Introduction</p><p>===============</p><p>It is awesome to have some useful services like <a href="https://aws.amazon.com/elasticsearch-service/">ElasticSearch managed by AWS</a>, so you don’t have to care about patching, monitoring, etc.</p><p>When it comes to backup management for indexes, Amazon ElasticSearch includes automated snapshots. Automated snapshots are only for cluster recovery. You can use them to restore your domain in the event of red cluster status or other data loss. Amazon ES stores automated snapshots in a preconfigured Amazon S3 bucket at no additional charge. In particular, if you are using a higher version than 5.3, Amazon ElasticSearch takes hourly automated snapshots and retains up to 336 of them for 14 days.</p><p>However, this policy might not be enough if you need to keep your snapshots for a longer 15 days, or you need to take a snapshot to create a new cluster in another region, subnet, etc. If you have different requirements to manage your snapshots, you will have to work with manual snapshots. For this part, AWS does not offer a good managed experience, since the solution is calling ElasticSearch Web API, as it is explained in <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-managedomains-snapshots.html#es-managedomains-snapshot-restore">this article</a>. In fact, even for automatic snapshots, you will also have to use ElasticSearch Web API if you need to restore your index.</p><p>In orther to make requests to ElasticSearch, they must be signed by AWS (<a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-request-signing.html">more info here</a>). For this purpose, AWS provides packages for multiple languages (Java, Python, Ruby, Node and  Go), but not for C#.</p><p>In this article, we will see how we can manage Amazon ElasticSearch snapshots with dotnet core.</p><h1 id="creating-elasticsearch-snapshots-with-dotnet-core">Creating ElasticSearch snapshots with dotnet core</h1><p>First of all, you need to cover some pre-requisites that are detailed <a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-managedomains-snapshots.html#es-managedomains-snapshot-restore">here</a>, as for the rest of languages:</p><ol><li>You have to create an S3 bucket. In this S3 bucket, you won’t be able to configure lifecycle policies to move to cold start or delete old data.<li>You have to create an IAM role with access to the S3 bucket created previously.<li>You need an IAM user and permissions to assume previous role or call elastic search with HTTP PUT.</ol><p>For the dotnet implementation, I created a new dotnet core AWS Lambda. In this way, I could invoke it from multiple sources. For example I can schedule a CloudWatch event to trigger it every day, every month, etc. The source code of this example can be found on <a href="https://github.com/albertocorrales/ElasticSearchSnapshotsLambda">this GitHub repository</a>.</p><p>First of all, this is my request object for AWS lambda input:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Request</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Endpoint</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">RepositoryName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">S3Bucket</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Region</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">RoleArn</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then this is the lambda handler:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">FunctionHandler</span><span class="p">(</span><span class="n">Request</span> <span class="n">request</span><span class="p">,</span> <span class="n">ILambdaContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">accessKey</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"ACCESS_KEY"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">secretKey</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="nf">GetEnvironmentVariable</span><span class="p">(</span><span class="s">"SECRET_KEY"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">signer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AWS4RequestSigner</span><span class="p">(</span><span class="n">accessKey</span><span class="p">,</span> <span class="n">secretKey</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">repositoryUrl</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">}</span><span class="s">/_snapshot/</span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">RepositoryName</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">service</span> <span class="p">=</span> <span class="s">"es"</span><span class="p">;</span>

        <span class="k">await</span> <span class="nf">RegisterS3Repository</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">signer</span><span class="p">,</span> <span class="n">repositoryUrl</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
        <span class="k">await</span> <span class="nf">CreateSnapshot</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">signer</span><span class="p">,</span> <span class="n">repositoryUrl</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="nf">LogLine</span><span class="p">(</span><span class="s">$"Error performing backup: </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As I mentioned previously, requests to ElasticSearch have signed and this is not supported by AWS. However, there is a signer for AWS that you can use from this project: <a href="https://github.com/tsibelman/aws-signer-v4-dot-net">https://github.com/tsibelman/aws-signer-v4-dot-net</a> by using <a href="https://github.com/tsibelman/aws-signer-v4-dot-net">this NuGet package</a>. Once we create the signer with AWS access key and secret key, we just have to register the repository and create the snapshot.</p><p>In order to register the S3 repository, we have to create the request, sign it and send it with PUT http operation:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">RegisterS3Repository</span><span class="p">(</span><span class="n">Request</span> <span class="n">request</span><span class="p">,</span> <span class="n">ILambdaContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">AWS4RequestSigner</span> <span class="n">signer</span><span class="p">,</span> <span class="kt">string</span> <span class="n">repositoryUrl</span><span class="p">,</span> <span class="kt">string</span> <span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="nf">LogLine</span><span class="p">(</span><span class="s">$"Register ElasticSearch Repository: </span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">RepositoryName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">requestBody</span> <span class="p">=</span> <span class="k">new</span>
    <span class="p">{</span>
        <span class="n">type</span> <span class="p">=</span> <span class="s">"s3"</span><span class="p">,</span>
        <span class="n">settings</span> <span class="p">=</span> <span class="k">new</span>
        <span class="p">{</span>
            <span class="n">bucket</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">S3Bucket</span><span class="p">,</span>
            <span class="n">region</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Region</span><span class="p">,</span>
            <span class="n">role_arn</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">RoleArn</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="kt">string</span> <span class="n">requestBodyString</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">requestBody</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">content</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringContent</span><span class="p">(</span><span class="n">requestBodyString</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">httpRequestRepository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpRequestMessage</span>
    <span class="p">{</span>
        <span class="n">Method</span> <span class="p">=</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="n">Put</span><span class="p">,</span>
        <span class="n">RequestUri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">repositoryUrl</span><span class="p">),</span>
        <span class="n">Content</span> <span class="p">=</span> <span class="n">content</span>
    <span class="p">};</span>

    <span class="n">httpRequestRepository</span> <span class="p">=</span> <span class="k">await</span> <span class="n">signer</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="n">httpRequestRepository</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Region</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">responseRepository</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">httpRequestRepository</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(!</span><span class="n">responseRepository</span><span class="p">.</span><span class="n">IsSuccessStatusCode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Error registering repository </span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">RepositoryName</span><span class="p">}</span><span class="s">.\n"</span> <span class="p">+</span>
            <span class="s">$"Error code: </span><span class="p">{</span><span class="n">responseRepository</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">}</span><span class="s">.\n"</span> <span class="p">+</span>
            <span class="s">$"Content: </span><span class="p">{</span><span class="k">await</span> <span class="n">responseRepository</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="nf">LogLine</span><span class="p">(</span><span class="s">$"ElasticSearch Repository </span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">RepositoryName</span><span class="p">}</span><span class="s"> successfully registered"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Once we register the repository, we can create new snapshots in a similar way, signing the request and sending a PUT http operation to $”{repositoryUrl}/{snapshotName}” endpoint:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CreateSnapshot</span><span class="p">(</span><span class="n">Request</span> <span class="n">request</span><span class="p">,</span> <span class="n">ILambdaContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">AWS4RequestSigner</span> <span class="n">signer</span><span class="p">,</span> <span class="kt">string</span> <span class="n">repositoryUrl</span><span class="p">,</span> <span class="kt">string</span> <span class="n">service</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">snapshotName</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"dd-MM-yyyy-h-mm-ss"</span><span class="p">).</span><span class="nf">ToLower</span><span class="p">();</span>

    <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="nf">LogLine</span><span class="p">(</span><span class="s">$"Create ElasticSearch Image: </span><span class="p">{</span><span class="n">repositoryUrl</span><span class="p">}</span><span class="s">/</span><span class="p">{</span><span class="n">snapshotName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">httpRequestSnapshot</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpRequestMessage</span>
    <span class="p">{</span>
        <span class="n">Method</span> <span class="p">=</span> <span class="n">HttpMethod</span><span class="p">.</span><span class="n">Put</span><span class="p">,</span>
        <span class="n">RequestUri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">repositoryUrl</span><span class="p">}</span><span class="s">/</span><span class="p">{</span><span class="n">snapshotName</span><span class="p">}</span><span class="s">"</span><span class="p">),</span>
        <span class="n">Content</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">};</span>

    <span class="n">httpRequestSnapshot</span> <span class="p">=</span> <span class="k">await</span> <span class="n">signer</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="n">httpRequestSnapshot</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Region</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">responseSnapshot</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">httpRequestSnapshot</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(!</span><span class="n">responseSnapshot</span><span class="p">.</span><span class="n">IsSuccessStatusCode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">$"Error creating snapshot </span><span class="p">{</span><span class="n">snapshotName</span><span class="p">}</span><span class="s">.\n"</span> <span class="p">+</span>
            <span class="s">$"Error code: </span><span class="p">{</span><span class="n">responseSnapshot</span><span class="p">.</span><span class="n">StatusCode</span><span class="p">}</span><span class="s">.\n"</span> <span class="p">+</span>
            <span class="s">$"Content: </span><span class="p">{</span><span class="k">await</span> <span class="n">responseSnapshot</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="nf">LogLine</span><span class="p">(</span><span class="s">$"ElasticSearch snapshot </span><span class="p">{</span><span class="n">snapshotName</span><span class="p">}</span><span class="s"> successfully registered"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="conclusions">Conclusions</h1><p>In this article, we have seen the options AWS ElasticSearch offers to create snapshots. In particular, the automatic way to create snapshots is quite limited and it is not configurable, so depending on our requirements we might need to create manual snapshots.</p><p>If we want to implement this process with dotnet core, in this article we have seen an example to implement a lambda which we can use go create manual snapshots. We could also extend this approach to build scheduled lambdas to remove old snapshots or any other operations.</p><p>In my personal opinion, Amazon ElasticSearch should offer better alternatives, for example integration with <a href="https://aws.amazon.com/backup/">AWS Backup</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/net/'>.net</a>, <a href='/categories/core/'>core</a>, <a href='/categories/2020/'>2020</a>, <a href='/categories/amazon/'>Amazon</a>, <a href='/categories/aws/'>AWS</a>, <a href='/categories/lambda/'>lambda</a>, <a href='/categories/backup/'>Backup</a>, <a href='/categories/elasticsearch/'>ElasticSearch</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Managing+snapshots+for+Amazon+ElasticSearch+with+Dotnet+Core+Lambdas+-+Alberto+Corrales+Garcia&url=https%3A%2F%2Falbertocorrales.com%2Fposts%2FManaging-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Managing+snapshots+for+Amazon+ElasticSearch+with+Dotnet+Core+Lambdas+-+Alberto+Corrales+Garcia&u=https%3A%2F%2Falbertocorrales.com%2Fposts%2FManaging-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Falbertocorrales.com%2Fposts%2FManaging-snapshots-for-Amazon-ElasticSearch-with-Dotnet-Core-Lambdas%2F&text=Managing+snapshots+for+Amazon+ElasticSearch+with+Dotnet+Core+Lambdas+-+Alberto+Corrales+Garcia" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Getting-starting-with-MCPs/">Getting started with MCPs, add super powers to your AI assistant</a><li><a href="/posts/Build-your-own-MCP/">Level Up Your AI Skills, Build a Custom MCP from Scratch</a><li><a href="/posts/Copier-template-projects/">Build Microservices at speed light with Copier</a><li><a href="/posts/CI-CD-pipelines-as-code-with-Nuke-build/">CI/CD pipelines-as-code with Nuke</a><li><a href="/posts/Working-with-event-sourcing-and-web-sockets/">Working with Event Sourcing, CQRS and Web Sockets on AWS</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ai-assistant/">AI assistant</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/architecture/">Architecture</a> <a class="post-tag" href="/tags/claude/">Claude</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/event-sourcing/">event sourcing</a> <a class="post-tag" href="/tags/eventstoredb/">EventStoreDB</a> <a class="post-tag" href="/tags/llm/">LLM</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Graph-databases-with-AWS-and-dotnet-core/"><div class="card-body"> <em class="small" data-ts="1592218911" data-df="ll" > Jun 15, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Graph databases with AWS and dotnet core</h3><div class="text-muted small"><p> Introduction Graph databases are NoSQL databases that store data using graph structures. In other words, your data will be stored as nodes and edges, which represent your objects and their relat...</p></div></div></a></div><div class="card"> <a href="/posts/Code-coverage-report-generation-for-dotnet-core-applications/"><div class="card-body"> <em class="small" data-ts="1602510525" data-df="ll" > Oct 12, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Code coverage report generation for dotnet core applications</h3><div class="text-muted small"><p> In “Working Effectively with Legacy Code” Michael Feathers introduced a definition of legacy code as code without tests, since a code without tests is difficult to maintain, extend and evolve. It...</p></div></div></a></div><div class="card"> <a href="/posts/Migrating-legacy-projects-to-.Net-CoreStandard/"><div class="card-body"> <em class="small" data-ts="1546850572" data-df="ll" > Jan 7, 2019 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Migrating legacy projects to .Net Core/Standard</h3><div class="text-muted small"><p> Introduction After the second version of .NET Core, it is pretty likely to be the future for .NET development, at least for many years. Luckily for legacy projects, Microsoft still continues sup...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/How-to-Setup-EventStoreDB-on-AWS-EC2-with-Pulumi-IaC/" class="btn btn-outline-primary" prompt="Older"><p>How to Setup EventStoreDB on AWS EC2 with Pulumi IaC</p></a> <a href="/posts/Building-Micro-Frontends-with-Single-Spa/" class="btn btn-outline-primary" prompt="Newer"><p>Building Micro-Frontends with Single-Spa</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/albertocorralex">Alberto Corrales Garcia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ai-assistant/">AI assistant</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/architecture/">Architecture</a> <a class="post-tag" href="/tags/claude/">Claude</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/event-sourcing/">event sourcing</a> <a class="post-tag" href="/tags/eventstoredb/">EventStoreDB</a> <a class="post-tag" href="/tags/llm/">LLM</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
