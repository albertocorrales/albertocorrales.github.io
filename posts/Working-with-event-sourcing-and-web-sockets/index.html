<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Working with Event Sourcing, CQRS and Web Sockets on AWS" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://albertocorrales.com/posts/Working-with-event-sourcing-and-web-sockets/" /><meta property="og:url" content="https://albertocorrales.com/posts/Working-with-event-sourcing-and-web-sockets/" /><meta property="og:site_name" content="Alberto Corrales Garcia" /><meta property="og:image" content="https://albertocorrales.com/assets/img/2023-01-18/0.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-18T11:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://albertocorrales.com/assets/img/2023-01-18/0.png" /><meta property="twitter:title" content="Working with Event Sourcing, CQRS and Web Sockets on AWS" /><meta name="twitter:site" content="@albertocorralex" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-01-19T23:48:16+01:00","datePublished":"2023-01-18T11:00:00+01:00","description":"Introduction","headline":"Working with Event Sourcing, CQRS and Web Sockets on AWS","image":"https://albertocorrales.com/assets/img/2023-01-18/0.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://albertocorrales.com/posts/Working-with-event-sourcing-and-web-sockets/"},"url":"https://albertocorrales.com/posts/Working-with-event-sourcing-and-web-sockets/"}</script><title>Working with Event Sourcing, CQRS and Web Sockets on AWS | Alberto Corrales Garcia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Alberto Corrales Garcia"><meta name="application-name" content="Alberto Corrales Garcia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://albertocorrales.com/assets/img/profile_pic.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Alberto Corrales Garcia</a></div><div class="site-subtitle font-italic">Software Development, Architecture, Cloud and Technology</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/albertocorrales" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/albertocorralex" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['albertocorralesgarcia','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Working with Event Sourcing, CQRS and Web Sockets on AWS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Working with Event Sourcing, CQRS and Web Sockets on AWS</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1674036000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 18, 2023 </em> </span> <span> Updated <em class="" data-ts="1674168496" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 19, 2023 </em> </span><div class="mt-3 mb-3"> <img data-src="/assets/img/2023-01-18/0.png" class="preview-img bg" alt="Preview Image" data-proofer-ignore></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/albertocorralex">Alberto Corrales Garcia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1504 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>The WebSocket API is an advanced technology that makes it possible to open a two-way interactive communication session between the user’s browser and a server. With this API, you can send messages to a server and receive event-driven responses without having to poll the server for a reply.</p><p>We normally use WebSockets when we want to get live updates of a particular object without having to constantly poll for new updates. In this scenario, WebSockets can be particularly helpful, as having many clients polling our APIs might increase the cost of our infrastructure, and if the number of request is very high, the API might apply throttling.</p><p>In this article, we will review how we could use WebSockets for EverntSourcing+CQRS. Nevertheless, you can follow the same approach for architectures that are not using that pattern, but you need to notify the clients when there are changes in a certain dataset.</p><h1 id="architecture">Architecture</h1><p>When we are using <a href="https://www.eventstore.com/blog/event-sourcing-and-cqrs">EventSourcing and CQRS</a>, we have commands that issue events. These events are projected into the state database. Then, we have queries that allow us to efficiently query the read models that we store in the state database.</p><p>In some scenarios, we might want to be notified in the frontend every time there is a change in a particular object, so we can refresh the UI with the latest data. Examples of these are chats, dashboards, push notifications, etc.</p><p>When we are using Event Sourcing and CQRS, we can leverage the capabilities of the projections for notifying our clients through WebSockets when the data changes.</p><p>In this architecture, from the client perspective, it only requires creating a new WebSocket connection and reacting when there are new events coming through the socket.</p><p>If we are using DynamoDB as our state database, an alternative to this could be using Streams on DynamoDB. In this case, when te data changes, DynamoDB streams invoke a lambda, which will notify the corresponding sockets. The disadvantage of this approach is the fact that it won’t work with other data stores (ElasticSearch, Neptune, etc). For this reason, notifying during after projecting the data is more generic.</p><p><img data-src="/assets/img/2023-01-18/1.png" alt="" data-proofer-ignore></p><p>Regarding the data we send though the WebSocket, ideally we would be sending the model we want to render in the frontend, so we can use directly the models we get through the WebSocket. However, this might not be suitable for some scenarios, as we night need to apply permissions or data aggregation for the DTOs we serve in our queries. If this is the case, we can just send a notification to our clients telling them that the data has changed, so they fetch latest from the Query API.</p><h1 id="security">Security</h1><p>For security reasons, the data we send though the socket must be encrypted. For this, it is important using secure WebSocket connections (wss).</p><p>Additionally, if our data is not public, we should implement authentication, so we ensure that only authenticated users can receive updates from the WebSocket.</p><p>The authentication on WebSockets works in a similar way as for HTTP APIs, so when we request creating a new connection, we send the access token. Then, the token will be validated by the authorizer in the API Gateway. However, how we pass the token in a WebSocket connection request might be a little different. For http request, we normally use the header <code class="language-plaintext highlighter-rouge">authorization</code>, but we cannot use custom headers in WebSockets when we are working with javascript. For this case, there are several alternatives, such as sending the token in the socket protocol or as a query parameter.</p><p>Apart from that, there are other alternatives that allow you to create the connection without authentication, and then the client sends the token in the first message, once the connection is open. The problem with this approach is the fact that we would be allowing the clients to create connections without passing the authentication, which might be less secure. For this reason, I would advise validating the token before the client creates a new connection.</p><h1 id="websockets-on-aws">WebSockets on AWS</h1><p>In order to implement WebSockets on AWS, API Gateway provides built-in support, so the service will automatically manage the communication between clients and server. In order to implement WebSockets, we need to create at least two lambdas: one for creating new connections and another lambda for closing connections. Optionally, we can create other lambdas for sending data.</p><p>Once you get a request for creating a new connection, you need to store the connection in a data store. In a similar way, when a connection is closed, you need to remove it from the store. This store will be used to know which connections we need to notify when there is a new update. If we try to send data to a connection and the connection is <code class="language-plaintext highlighter-rouge">GONE</code>, we can delete the connection from the data store. In our architecture, we store the WebSocket connections in MemoryDB for performance reasons, but you could pick any data stores you prefer.</p><p>In spite of the fact that you can you can use the default domain that AWS API Gateway generates automatically, it is recommended creating your own subdomain (for example wss://websockets.my-domain.com) and create a new endpoint in API Gateway for WebSockets.</p><p>Here you have examples of WebSockets applications in <a href="https://github.com/aws-samples/simple-websockets-chat-app">javascript</a> and <a href="https://github.com/normj/netcore-simple-websockets-chat-app">csharp</a>.</p><h1 id="websockets-javascript-clients">WebSockets JavaScript clients</h1><p>In order to implement your javascript client, you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">class WebSocket</a>.</p><p>If you are using react hooks, our code would look similar to this example:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">[</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">setSocket</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">useState</span> <span class="o">&lt;</span> <span class="nx">WebSocket</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">&gt;</span> <span class="kc">undefined</span><span class="p">);</span>

<span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">webSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span>
      <span class="dl">"</span><span class="s2">wss://websockets.my-domain.com/notifications</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">accessToken</span>
    <span class="p">);</span>

    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">open</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">refreshMyData</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">webSocket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">DataUpdated</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">refreshMyData</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">setSocket</span><span class="p">(</span><span class="nx">webSocket</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">fiveMinutesInMilliseconds</span> <span class="o">=</span> <span class="mi">300</span><span class="nx">_000</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span> <span class="o">&amp;&amp;</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">PING</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="nx">fiveMinutesInMilliseconds</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">interval</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">},</span> <span class="p">[]);</span>
</pre></table></code></div></div><p>In this example, we would be fetching the latest data with the method <code class="language-plaintext highlighter-rouge">refreshMyData()</code> every time there is an update. In addition, once the connection is open, we fetch the data, so we are sure that we are displaying the latest version of the object. This part wouldn’t be needed if you only care about new events (for example in a chat room).</p><p>In addition, you should also bear in mind the <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html">AWS API Gateway quotas</a>. For example, AWS API Gateway would close any connections that have been idle for more than 10 minutes. If you don’t want this to happen, you should ping the WebSocket from time to time in order to keep it alive. In the example above, we just create an interval that pings the socket every 5 minutes.</p><p>Finally, when you unload the component in the UI, you should clear ping interval (if you are using any) and close the connection.</p><h1 id="testing-web-sockets">Testing Web Sockets</h1><p>In order to mock the socket in unit tests, you can use the npm package <a href="https://github.com/romgain/jest-websocket-mock"><code class="language-plaintext highlighter-rouge">jest-websocket-mock</code></a>, so you can mock it and check that is it is working as expected.</p><p>For integration tests, you can implement integration tests where you subscribe to a particular object with a web socket. After that, you can issue commands and check if you are getting the updates through the web socket.</p><p>Finally, for end-to-end tests, we don’t need to do anything specific. However, if you are using Cypress, I spotted <a href="https://github.com/cypress-io/cypress/issues/7664">an issue</a> with Cypress when we are working with WebSockets, as it closes the before receiving the handshake response.</p><p>If you are facing this issue, you need to bypass the WebSockets endpoint in your cypress configuration, so cypress won’t proxy these requests. For that, we would add this custom configuration in the file <code class="language-plaintext highlighter-rouge">cypress.config.ts</code>.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">cypress</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
  <span class="nx">setupNodeEvents</span><span class="p">(</span><span class="nx">on</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">before:browser:launch</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">browser</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">launchOptions</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">launchOptions</span><span class="p">.</span><span class="nx">args</span> <span class="o">=</span> <span class="nx">launchOptions</span><span class="p">.</span><span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">arg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">--proxy-bypass-list</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="dl">"</span><span class="s2">--proxy-bypass-list=&lt;-loopback&gt;,wss://websockets.my-domain.com</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">launchOptions</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></table></code></div></div><h1 id="conclusions">Conclusions</h1><p>In this post, we have seen what WebSockets are and how we can use them to reduce the number of requests we perform to our APIs when we need to keep updated our clients.</p><p>As we have discussed, WebSockets can be specially relevant to prevent polling our APIs, which could overload them, increasing the cost or even consuming part of the traffic quota.</p><p>In this post, we have also analyzed an architecture that leverages Event Sourcing and CQRS to send updates through WebSockets, so the web clients can get updates in real time.</p><p>Finally, we have explained how WebSockets can be implemented, including the backend with AWS API Gateway + Lambdas, and the frontend with the provided API for WebSockets.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/eventstoredb/" class="post-tag no-text-decoration" >EventStoreDB</a> <a href="/tags/event-sourcing/" class="post-tag no-text-decoration" >event sourcing</a> <a href="/tags/cqrs/" class="post-tag no-text-decoration" >CQRS</a> <a href="/tags/websockets/" class="post-tag no-text-decoration" >WebSockets</a> <a href="/tags/architecture/" class="post-tag no-text-decoration" >Architecture</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Working+with+Event+Sourcing%2C+CQRS+and+Web+Sockets+on+AWS+-+Alberto+Corrales+Garcia&url=https%3A%2F%2Falbertocorrales.com%2Fposts%2FWorking-with-event-sourcing-and-web-sockets%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Working+with+Event+Sourcing%2C+CQRS+and+Web+Sockets+on+AWS+-+Alberto+Corrales+Garcia&u=https%3A%2F%2Falbertocorrales.com%2Fposts%2FWorking-with-event-sourcing-and-web-sockets%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Falbertocorrales.com%2Fposts%2FWorking-with-event-sourcing-and-web-sockets%2F&text=Working+with+Event+Sourcing%2C+CQRS+and+Web+Sockets+on+AWS+-+Alberto+Corrales+Garcia" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Getting-starting-with-MCPs/">Getting started with MCPs, add super powers to your AI assistant</a><li><a href="/posts/Build-your-own-MCP/">Level Up Your AI Skills, Build a Custom MCP from Scratch</a><li><a href="/posts/Copier-template-projects/">Build Microservices at speed light with Copier</a><li><a href="/posts/CI-CD-pipelines-as-code-with-Nuke-build/">CI/CD pipelines-as-code with Nuke</a><li><a href="/posts/Working-with-event-sourcing-and-web-sockets/">Working with Event Sourcing, CQRS and Web Sockets on AWS</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ai-assistant/">AI assistant</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/architecture/">Architecture</a> <a class="post-tag" href="/tags/claude/">Claude</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/event-sourcing/">event sourcing</a> <a class="post-tag" href="/tags/eventstoredb/">EventStoreDB</a> <a class="post-tag" href="/tags/llm/">LLM</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Scaling-up-down-event-store-without-downtime/"><div class="card-body"> <em class="small" data-ts="1665741600" data-df="ll" > Oct 14, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Scaling up/down EventStoreDB without downtime</h3><div class="text-muted small"><p> Introduction EventStoreDB (ESDB) is a log stream database oriented to architectures based on event-sourcing. The data in EventStoreDB is stored into streams, and each stream contains a log of even...</p></div></div></a></div><div class="card"> <a href="/posts/Dropping-the-cost-of-dynamodb/"><div class="card-body"> <em class="small" data-ts="1661680800" data-df="ll" > Aug 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dropping the cost of DynamoDB</h3><div class="text-muted small"><p> Introduction DynamoDB is the most popular NoSql database on AWS. It allows you to easily build high performant applications taking care of the good practices, such as: encryption, access control, ...</p></div></div></a></div><div class="card"> <a href="/posts/Copier-template-projects/"><div class="card-body"> <em class="small" data-ts="1737885600" data-df="ll" > Jan 26, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Build Microservices at speed light with Copier</h3><div class="text-muted small"><p> Build Microservices at speed light with Copier Introduction Templating tools are critical in modern microservices architecture, solving key challenges in rapid and consistent software development...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Scaling-up-down-event-store-without-downtime/" class="btn btn-outline-primary" prompt="Older"><p>Scaling up/down EventStoreDB without downtime</p></a> <a href="/posts/CI-CD-pipelines-as-code-with-Nuke-build/" class="btn btn-outline-primary" prompt="Newer"><p>CI/CD pipelines-as-code with Nuke</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/albertocorralex">Alberto Corrales Garcia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/ai-assistant/">AI assistant</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/architecture/">Architecture</a> <a class="post-tag" href="/tags/claude/">Claude</a> <a class="post-tag" href="/tags/cloud/">cloud</a> <a class="post-tag" href="/tags/cqrs/">CQRS</a> <a class="post-tag" href="/tags/event-sourcing/">event sourcing</a> <a class="post-tag" href="/tags/eventstoredb/">EventStoreDB</a> <a class="post-tag" href="/tags/llm/">LLM</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
